---
import Layout from "../layouts/Layout.astro";
import HeroCarousel from "../components/carousel/HeroCarousel.tsx";
import SectionBlock from "../components/SectionBlock.astro";
import BlogPostCard from "../components/BlogPostCard.astro";
import Button from "../components/Button.astro";
import { SITE_NAME } from "../consts";

const blogModules = import.meta.glob<{
  frontmatter: Record<string, any>;
  url: string;
}>("./blog/*.mdx", { eager: true });
const posts = Object.values(blogModules);
const latestPosts = posts
  .sort(
    (a, b) =>
      new Date(b.frontmatter.date).getTime() -
      new Date(a.frontmatter.date).getTime(),
  )
  .slice(0, 3);

const projectModules = import.meta.glob<{
  frontmatter: Record<string, any>;
  url: string;
}>("./projects/*.mdx", { eager: true });
const softwareProjects = Object.values(projectModules).filter(
  (p) => p.frontmatter.category === "software",
);

const sortedProjects = [...softwareProjects].sort((a, b) => {
  const aHas = a.frontmatter.images && a.frontmatter.images.length > 0 ? 0 : 1;
  const bHas = b.frontmatter.images && b.frontmatter.images.length > 0 ? 0 : 1;
  return aHas - bHas;
});

const slides = sortedProjects.map((p) => ({
  image: p.frontmatter.images?.[0],
  alt: p.frontmatter.title,
  project: {
    title: p.frontmatter.title,
    subtitle: p.frontmatter.subtitle,
    tech: p.frontmatter.tech,
    status: p.frontmatter.status,
    current: p.frontmatter.current,
    href: `/projects/${p.url!.split("/").pop()!}`,
  },
}));

function formatDate(dateStr: string) {
  const d = new Date(dateStr);
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, "0");
  const day = String(d.getDate()).padStart(2, "0");
  return `${y}.${m}.${day}`;
}

const now = Date.now();
const thirtyDays = 30 * 24 * 60 * 60 * 1000;
const latestDate =
  latestPosts.length > 0
    ? formatDate(latestPosts[0].frontmatter.date)
    : "----.--.--";

const featuredPost = latestPosts[0];
const archivePosts = latestPosts.slice(1);
---

<Layout transparentHeader>
  <main>
    <section class="hero-section">
      <HeroCarousel slides={slides} fullscreen client:idle />
    </section>

    <!-- ============ BLOG ============ -->
    <section class="preview-section">
      <SectionBlock title="ARTICLES///">
        <div class="section-bar" aria-hidden="true">
          <div class="section-bar__info">
            <span class="section-bar__accent">WRITING.FEED</span>
            <span class="section-bar__sep">//</span>
            <span>LAST TX {latestDate}</span>
            <span class="section-bar__sep">//</span>
            <span>{latestPosts.length} DISPATCHES</span>
            <span class="section-bar__sep">//</span>
            <span>SIGNAL OK</span>
          </div>
        </div>

        <div class="blog-feed">
          <div class="scanline-bg"></div>

          <!-- Featured post -->
          {
            featuredPost && (
              <div class="blog-featured">
                <div class="blog-featured__badge">
                  <span>LATEST</span>
                </div>
                <div class="blog-featured__card">
                  <BlogPostCard
                    url={featuredPost.url!}
                    title={featuredPost.frontmatter.title}
                    date={featuredPost.frontmatter.date}
                    description={featuredPost.frontmatter.description}
                    tags={featuredPost.frontmatter.tags}
                    isNew={
                      now - new Date(featuredPost.frontmatter.date).getTime() <
                      thirtyDays
                    }
                    index={1}
                    delay={0}
                  />
                </div>
              </div>
            )
          }

          <!-- Archive divider -->
          {
            archivePosts.length > 0 && (
              <div class="blog-divider">
                <span class="blog-divider__label">ARCHIVE</span>
                <span class="blog-divider__rule" />
              </div>
            )
          }

          <!-- Archive list -->
          <div class="blog-archive">
            {
              archivePosts.map((post, i) => (
                <BlogPostCard
                  url={post.url!}
                  title={post.frontmatter.title}
                  date={post.frontmatter.date}
                  description={post.frontmatter.description}
                  tags={post.frontmatter.tags}
                  isNew={
                    now - new Date(post.frontmatter.date).getTime() < thirtyDays
                  }
                  index={i + 2}
                  delay={i + 1}
                />
              ))
            }
          </div>
        </div>

        <div class="section-action" data-animate>
          <Button href="/blog">All Dispatches</Button>
        </div>
      </SectionBlock>
    </section>

    <!-- ============ ABOUT ============ -->
    <section class="preview-section">
      <SectionBlock title="ABOUT///">
        <!-- Ticker strip -->
        <div class="ticker" aria-hidden="true">
          <div class="ticker__track">
            {
              [0, 1].map(() => (
                <span class="ticker__segment">
                  {[0, 1, 2].map(() => (
                    <>
                      <span>WHO IS THIS</span>
                      <span class="ticker__dot" />
                      <span>PROFILE LOADED</span>
                      <span class="ticker__dot" />
                      <span>CLEARANCE OK</span>
                      <span class="ticker__dot" />
                      <span>DOSSIER READY</span>
                      <span class="ticker__dot" />
                    </>
                  ))}
                </span>
              ))
            }
          </div>
        </div>

        <!-- About HUD display -->
        <div class="about-hud">
          <div class="dot-grid dot-grid--faint"></div>
          <div class="about-hud__inner">
            <!-- Terminal block -->
            <div class="terminal-block" data-animate>
              <div class="terminal-block__header">
                <span class="led led--active led--sm"></span>
                <span>UNRESOLVED TICKETS // 3 OPEN</span>
              </div>
              <div class="terminal-block__body">
                <p class="terminal-line">
                  <span class="terminal-prompt">&gt;</span> How far can you push
                  a homelab before it pushes back?
                </p>
                <p class="terminal-line">
                  <span class="terminal-prompt">&gt;</span> What makes an interface
                  feel deliberate and alive?
                </p>
                <p class="terminal-line">
                  <span class="terminal-prompt">&gt;</span> When does a declarative
                  config cross from reproducible into impractical?
                </p>
                <p class="terminal-line terminal-line--cursor">
                  <span class="terminal-prompt">&gt;</span>
                  <span class="terminal-cursor"></span>
                </p>
              </div>
            </div>

            <!-- Profile card -->
            <div class="profile-card" data-animate>
              <div class="profile-card__header">
                <span>PROFILE</span>
              </div>
              <div class="profile-card__body">
                <div class="profile-meta">
                  <span class="profile-meta__label">HANDLE</span>
                  <span class="profile-meta__value">{SITE_NAME}</span>

                  <span class="profile-meta__label">INTERESTS</span>
                  <span class="profile-meta__value">
                    Web, Containerization, Linux, UI/UX
                  </span>

                  <span class="profile-meta__label">STACK</span>
                  <span class="profile-meta__value">
                    TS / React / Svelte / Python
                  </span>

                  <span class="profile-meta__label">STATUS</span>
                  <span class="profile-meta__value profile-meta__value--status">
                    <span class="led led--active led--sm"></span>
                    ACTIVE
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="section-action" data-animate>
          <Button href="/about">Full Dossier</Button>
        </div>
      </SectionBlock>
    </section>
  </main>
</Layout>

<style>
  .hero-section {
    margin-top: calc(-3.5rem - 1px);
  }

  .preview-section {
    border: 1px solid var(--color-border);
    border-top: 0;
  }

  .section-action {
    display: flex;
    justify-content: flex-end;
    padding: var(--spacing-xl);
    padding-top: var(--spacing-md);
  }

  /* ========================================
   * Blog Section
   * ======================================== */
  .section-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    padding: 0.5rem var(--spacing-xl);
    border-bottom: 1px solid var(--color-border);
    background: var(--color-bg-secondary);
  }

  .section-bar__info {
    display: flex;
    align-items: center;
    gap: 0.6rem;
    font-family: monospace;
    font-size: var(--font-size-xs);
    color: var(--color-text-muted);
    letter-spacing: 0.05em;
    white-space: nowrap;
    overflow: hidden;
  }

  .section-bar__sep {
    color: var(--color-accent);
    opacity: 0.5;
  }

  .section-bar__accent {
    color: var(--color-accent);
    font-weight: 700;
  }

  .blog-feed {
    position: relative;
    padding: 2rem var(--spacing-xl);
    padding-left: calc(var(--spacing-xl) - 3.5rem);
  }

  .blog-featured {
    position: relative;
    margin-bottom: 1.5rem;
  }

  .blog-featured__badge {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-family: monospace;
    font-size: var(--font-size-xs);
    color: var(--color-accent);
    letter-spacing: 0.05em;
    margin-bottom: 0.6rem;
    padding-left: 3.5rem;
  }

  .blog-featured__card {
    position: relative;
    border-left: 3px solid var(--color-accent);
    box-shadow: -4px 0 12px var(--color-accent-subtle);
    border-radius: 2px;
  }

  .blog-featured :global(.blog-entry__title) {
    font-size: var(--font-size-4xl);
  }

  .blog-divider {
    display: flex;
    align-items: center;
    gap: 0.8rem;
    padding: 1rem 0 1rem 3.5rem;
  }

  .blog-divider__label {
    font-family: monospace;
    font-size: var(--font-size-xs);
    color: var(--color-text-muted);
    letter-spacing: 0.1em;
    flex-shrink: 0;
  }

  .blog-divider__rule {
    flex: 1;
    height: 0;
    border-top: 1px solid var(--color-border);
  }

  .blog-archive {
    position: relative;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  /* ========================================
   * About Section
   * ======================================== */
  .about-hud {
    position: relative;
    padding: 2rem var(--spacing-xl);
  }

  .about-hud__inner {
    position: relative;
    display: grid;
    grid-template-columns: 1.2fr 0.8fr;
    gap: 1.5rem;
  }

  /* Terminal block */
  .terminal-block {
    --cut: 0.75rem;
    background: var(--color-border);
    clip-path: var(--clip-cutoff);
    padding: 1px;
  }

  .terminal-block__header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.6rem 1.2rem;
    background: var(--color-bg-tertiary);
    font-family: monospace;
    font-size: var(--font-size-xs);
    color: var(--color-text-muted);
    letter-spacing: 0.05em;
    clip-path: polygon(var(--cut) 0, 100% 0, 100% 100%, 0 100%, 0 var(--cut));
  }

  .terminal-block__body {
    background: var(--color-bg-secondary);
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 0.8rem;
    clip-path: polygon(
      0 0,
      100% 0,
      100% calc(100% - var(--cut)),
      calc(100% - var(--cut)) 100%,
      0 100%
    );
  }

  .terminal-line {
    font-family: monospace;
    font-size: var(--font-size-base);
    color: var(--color-text-secondary);
    line-height: 1.6;
    margin: 0;
  }

  .terminal-prompt {
    color: var(--color-accent);
    margin-right: 0.5rem;
  }

  .terminal-line--cursor {
    display: flex;
    align-items: center;
    gap: 0;
  }

  .terminal-cursor {
    display: inline-block;
    width: 0.5rem;
    height: 1em;
    background: var(--color-accent);
    animation: cursor-blink 1s step-end infinite;
  }

  @keyframes cursor-blink {
    0%,
    100% {
      opacity: 1;
    }
    50% {
      opacity: 0;
    }
  }

  /* Profile card */
  .profile-card {
    --cut: 0.75rem;
    background: var(--color-border);
    clip-path: polygon(
      0 0,
      100% 0,
      100% calc(100% - var(--cut)),
      calc(100% - var(--cut)) 100%,
      0 100%
    );
    padding: 1px;
    display: flex;
    flex-direction: column;
  }

  .profile-card__header {
    padding: 0.6rem 1.2rem;
    background: var(--color-bg-tertiary);
    font-family: monospace;
    font-size: var(--font-size-xs);
    color: var(--color-text-muted);
    letter-spacing: 0.05em;
  }

  .profile-card__body {
    background: var(--color-bg-secondary);
    padding: 1.5rem;
    flex: 1;
    clip-path: polygon(
      0 0,
      100% 0,
      100% calc(100% - var(--cut)),
      calc(100% - var(--cut)) 100%,
      0 100%
    );
  }

  .profile-meta {
    display: grid;
    grid-template-columns: auto 1fr;
    gap: 0.6rem 1.2rem;
    align-items: baseline;
  }

  .profile-meta__label {
    font-family: monospace;
    font-size: var(--font-size-xs);
    color: var(--color-text-muted);
    letter-spacing: 0.05em;
  }

  .profile-meta__value {
    color: var(--color-text-secondary);
    font-size: var(--font-size-md);
  }

  .profile-meta__value--status {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    color: var(--color-accent);
    font-family: monospace;
    font-size: var(--font-size-xs);
    letter-spacing: 0.05em;
  }

  /* ========================================
   * Responsive
   * ======================================== */
  @media (max-width: 768px) {
    .blog-feed {
      padding: 1.5rem 1rem;
      padding-left: 0.5rem;
    }

    .blog-featured__card {
      border-left: none;
      box-shadow: none;
    }

    .blog-featured__badge {
      padding-left: 0;
    }

    .blog-featured :global(.blog-entry__title) {
      font-size: var(--font-size-2xl);
    }

    .blog-divider {
      padding-left: 0;
    }

    .about-hud__inner {
      grid-template-columns: 1fr;
    }
  }
</style>
