---
import Layout from "../layouts/Layout.astro";
import PageHeading from "../components/PageHeading.astro";
import BlogPostCard from "../components/BlogPostCard.astro";

const posts = await Astro.glob("./blog/*.mdx");

const sorted = posts
  .filter((p) => p.frontmatter.title)
  .sort(
    (a, b) =>
      new Date(b.frontmatter.date).getTime() -
      new Date(a.frontmatter.date).getTime(),
  );

const now = Date.now();
const thirtyDays = 30 * 24 * 60 * 60 * 1000;

function formatDate(dateStr: string) {
  const d = new Date(dateStr);
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, "0");
  const day = String(d.getDate()).padStart(2, "0");
  return `${y}.${m}.${day}`;
}

const latestDate =
  sorted.length > 0 ? formatDate(sorted[0].frontmatter.date) : "----.--.--";
---

<Layout title="7591yj | Blog">
  <main>
    <section>
      <PageHeading module="MODULE.002///" title="Blog" />
    </section>

    <section class="feed-section">
      <!-- ticker strip -->
      <div class="ticker" aria-hidden="true">
        <div class="ticker__track">
          {
            [0, 1].map(() => (
              <span class="ticker__half">
                {
                  [0, 1, 2].map(() => (
                    <>
                      <span>SIGNAL CLEAR</span>
                      <span class="ticker__dot" />
                      <span>{sorted.length} ENTRIES LOADED</span>
                      <span class="ticker__dot" />
                      <span>LATEST {latestDate}</span>
                      <span class="ticker__dot" />
                      <span>SYS.BLOG ACTIVE</span>
                      <span class="ticker__dot" />
                      <span>TRANSMISSION OK</span>
                      <span class="ticker__dot" />
                    </>
                  ))
                }
              </span>
            ))
          }
        </div>
      </div>

      <!-- article feed -->
      <div class="feed">
        <div class="feed__grid"></div>
        <div class="feed__list">
          {
            sorted.length > 0 ? (
              sorted.map((post, i) => (
                <BlogPostCard
                  url={post.url!}
                  title={post.frontmatter.title}
                  date={formatDate(post.frontmatter.date)}
                  description={post.frontmatter.description}
                  tags={post.frontmatter.tags}
                  isNew={
                    now - new Date(post.frontmatter.date).getTime() < thirtyDays
                  }
                  index={sorted.length - i}
                  delay={Math.min(i + 1, 5)}
                />
              ))
            ) : (
              <p class="empty" data-animate>
                &gt; No entries found. Awaiting transmission&hellip;
              </p>
            )
          }
        </div>
      </div>
    </section>
  </main>
</Layout>

<style>
  /* ---- Feed section ---- */
  .feed-section {
    border: 1px solid var(--color-border);
    border-top: 0;
  }

  /* ---- Ticker strip ---- */
  .ticker {
    overflow: hidden;
    border-bottom: 1px solid var(--color-border);
    background: var(--color-bg-secondary);
    padding: 0.6rem 0;
  }

  .ticker__track {
    display: flex;
    width: max-content;
    animation: ticker-scroll 40s linear infinite;
  }

  .ticker__track:hover {
    animation-play-state: paused;
  }

  @keyframes ticker-scroll {
    0% {
      transform: translateX(0);
    }
    100% {
      transform: translateX(-50%);
    }
  }

  .ticker__half {
    display: flex;
    align-items: center;
    gap: 1.5rem;
    padding-right: 1.5rem;
    font-family: monospace;
    font-size: 0.68rem;
    color: var(--color-text-muted);
    letter-spacing: 0.06em;
    white-space: nowrap;
    flex-shrink: 0;
  }

  .ticker__dot {
    width: 0.25rem;
    height: 0.25rem;
    border-radius: 50%;
    background: var(--color-text-muted);
    opacity: 0.4;
    flex-shrink: 0;
  }

  /* ---- Feed area ---- */
  .feed {
    position: relative;
    padding: 2rem 6.4vh;
    padding-left: calc(6.4vh - 3.5rem);
  }

  .feed__grid {
    position: absolute;
    inset: 0;
    background-image: radial-gradient(
      circle,
      var(--color-border) 1px,
      transparent 1px
    );
    background-size: 24px 24px;
    pointer-events: none;
    opacity: 0.5;
  }

  .feed__list {
    position: relative;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .empty {
    font-family: monospace;
    font-size: 0.8rem;
    color: var(--color-text-muted);
    padding: 2rem 3.5rem;
  }

  @media (max-width: 768px) {
    .feed {
      padding: 1.5rem 1rem;
      padding-left: 0.5rem;
    }
  }
</style>
