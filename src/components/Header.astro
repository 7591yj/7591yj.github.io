---
import ThemeToggle from "./ThemeToggle.astro";
import LanguageSelect from "./LanguageSelect.astro";
import { SITE_NAME } from "../consts";

interface Props {
  transparentHeader?: boolean;
}

const { transparentHeader = false } = Astro.props;
const navItems = [
  { label: "Home", href: "/" },
  { label: "Projects", href: "/projects" },
  { label: "Blog", href: "/blog" },
  { label: "About", href: "/about" },
];
const currentPath = Astro.url.pathname;
---

<header
  class:list={["header", { "header--transparent": transparentHeader }]}
  {...transparentHeader ? { "data-transparent-header": "" } : {}}
>
  <div class="header-inner container-header">
    <button class="hamburger" aria-label="Menu" aria-expanded="false">
      <span class="hamburger__line"></span>
      <span class="hamburger__line"></span>
      <span class="hamburger__line"></span>
    </button>
    <nav>
      <div class="nav-main">
        {
          navItems.map(({ label, href }) => (
            <a
              href={href}
              class:list={["nav-link", { active: currentPath === href }]}
              data-scramble={label}
            >
              {label}
            </a>
          ))
        }
      </div>
    </nav>
    <a href="/" class="logo">{SITE_NAME}</a>
    <nav class="nav-sub justify-end">
      <LanguageSelect />
      <ThemeToggle />
    </nav>
  </div>
</header>

<!-- Mobile overlay menu -->
<div class="mobile-menu">
  <div class="dot-grid dot-grid--faint"></div>
  <nav class="mobile-menu__nav">
    {
      navItems.map(({ label, href }) => (
        <a
          href={href}
          class:list={["mobile-menu__link", { active: currentPath === href }]}
        >
          {label}
        </a>
      ))
    }
  </nav>
</div>

<style>
  .header {
    position: sticky;
    top: 0;
    z-index: var(--z-sticky);
    backdrop-filter: blur(0.64vw);
    background: var(--color-bg-primary);
    border-bottom: 1px solid var(--color-border);
    view-transition-name: site-header;
    transition:
      background var(--duration-normal) var(--ease-out-expo),
      border-color var(--duration-normal) var(--ease-out-expo),
      backdrop-filter var(--duration-normal) var(--ease-out-expo);
  }

  /* Transparent mode (over hero carousel) */
  .header--transparent {
    background: rgba(0, 0, 0, 0.3);
    border-bottom-color: var(--color-border);
    backdrop-filter: blur(6px);
  }

  .header--transparent .logo {
    color: #fff;
  }

  .header--transparent .nav-link {
    color: rgba(255, 255, 255, 0.7);
  }

  .header--transparent .nav-link:hover {
    color: #fff;
  }

  .header--transparent .nav-link.active {
    color: #fff;
  }

  .header--transparent .nav-main {
    border-right-color: var(--color-border);
  }

  .header--transparent :global(.theme-toggle) {
    color: rgba(255, 255, 255, 0.7);
  }

  .header--transparent :global(.theme-toggle:hover) {
    color: #fff;
  }

  .header--transparent :global(.lang-select .nav-link) {
    color: rgba(255, 255, 255, 0.7);
    border-left-color: var(--color-border);
    border-right-color: var(--color-border);
  }

  .header--transparent :global(.lang-select .nav-link:hover) {
    color: #fff;
  }

  /* Scrolled state (restores solid header) */
  .header--scrolled {
    background: var(--color-bg-primary);
    border-bottom-color: var(--color-border);
    backdrop-filter: blur(0.64vw);
  }
  .header-inner {
    display: flex;
    align-items: center;
    justify-content: space-between;
    height: 3.5rem;
  }
  .header-inner nav {
    flex: 1;
  }
  .logo {
    font-weight: 700;
    font-size: var(--font-size-3xl);
    color: var(--color-text-primary);
    text-decoration: none;
    letter-spacing: -0.02em;
  }
  nav {
    display: flex;
    align-items: center;
    height: 100%;
    gap: var(--spacing-sm);
  }
  .nav-link {
    display: flex;
    align-items: center;
    color: var(--color-text-secondary);
    text-decoration: none;
    font-size: var(--font-size-md);
    padding: 0.35rem 1.75rem;
    height: 100%;
    transition:
      color var(--duration-fast) ease,
      background var(--duration-fast) ease;
    gap: 0.75rem;
  }
  .nav-link:hover {
    color: var(--color-text-primary);
  }
  .nav-link.active {
    color: var(--color-accent);
  }
  .nav-main {
    display: flex;
    height: 100%;
    border-right: 1px solid var(--color-border);
    padding: 0 3rem;
  }

  /* ========================================
   * Hamburger Button
   * ======================================== */
  .hamburger {
    display: none;
    flex-direction: column;
    justify-content: center;
    gap: 4px;
    width: 2.5rem;
    height: 2.5rem;
    padding: 0.5rem;
    background: none;
    border: none;
    cursor: pointer;
  }

  .hamburger:hover .hamburger__line:nth-child(1) {
    transform: translateX(3px);
  }

  .hamburger:hover .hamburger__line:nth-child(3) {
    transform: translateX(-3px);
  }

  .hamburger__line {
    display: block;
    width: 100%;
    height: 2px;
    background: var(--color-text-primary);
    transition:
      transform var(--duration-normal) var(--ease-out-expo),
      opacity var(--duration-fast) ease;
  }

  .header--transparent .hamburger__line {
    background: #fff;
  }

  .header--transparent.header--scrolled .hamburger__line {
    background: var(--color-text-primary);
  }

  /* Hamburger â†’ X animation */
  .hamburger[aria-expanded="true"] .hamburger__line:nth-child(1) {
    transform: translateY(6px) rotate(45deg);
  }

  .hamburger[aria-expanded="true"] .hamburger__line:nth-child(2) {
    opacity: 0;
  }

  .hamburger[aria-expanded="true"] .hamburger__line:nth-child(3) {
    transform: translateY(-6px) rotate(-45deg);
  }

  /* ========================================
   * Mobile Menu Overlay
   * ======================================== */
  .mobile-menu {
    display: none;
    position: fixed;
    top: 3.5rem;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--color-bg-primary);
    z-index: var(--z-overlay);
    opacity: 0;
    visibility: hidden;
    transition:
      opacity var(--duration-normal) var(--ease-out-expo),
      visibility var(--duration-normal) var(--ease-out-expo);
  }

  .mobile-menu.open {
    opacity: 1;
    visibility: visible;
  }

  .mobile-menu__nav {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    gap: 1rem;
    position: relative;
    z-index: 1;
  }

  .mobile-menu__link {
    color: var(--color-text-secondary);
    text-decoration: none;
    font-size: var(--font-size-3xl);
    font-weight: 700;
    letter-spacing: -0.02em;
    padding: 0.75rem 2rem;
    transition: color var(--duration-fast) ease;
  }

  .mobile-menu__link:hover {
    color: var(--color-text-primary);
  }

  .mobile-menu__link.active {
    color: var(--color-accent);
  }

  /* ========================================
   * Mobile Breakpoint
   * ======================================== */
  @media (max-width: 768px) {
    .hamburger {
      display: flex;
    }

    .nav-main {
      display: none;
    }

    .mobile-menu {
      display: block;
    }

    .header-inner nav:first-of-type {
      flex: 0;
    }

    .logo {
      margin-left: 0.5rem;
    }

    /* Menu-open: neutralize transparent header */
    .header--transparent.header--menu-open {
      background: var(--color-bg-primary);
      border-bottom-color: var(--color-border);
      backdrop-filter: blur(0.64vw);
    }

    .header--transparent.header--menu-open .logo {
      color: var(--color-text-primary);
    }

    .header--transparent.header--menu-open .hamburger__line {
      background: var(--color-text-primary);
    }

    .header--transparent.header--menu-open :global(.theme-toggle) {
      color: var(--color-text-secondary);
    }

    .header--transparent.header--menu-open :global(.theme-toggle:hover) {
      color: var(--color-text-primary);
    }

    .header--transparent.header--menu-open :global(.lang-select .nav-link) {
      color: var(--color-text-secondary);
      border-left-color: var(--color-border);
      border-right-color: var(--color-border);
    }

    .header--transparent.header--menu-open
      :global(.lang-select .nav-link:hover) {
      color: var(--color-text-primary);
    }
  }
</style>

<script>
  function initHamburger() {
    const header = document.querySelector(".header");
    const hamburger = document.querySelector(".hamburger");
    const mobileMenu = document.querySelector(".mobile-menu");
    if (!header || !hamburger || !mobileMenu) return;

    function close() {
      hamburger!.setAttribute("aria-expanded", "false");
      mobileMenu!.classList.remove("open");
      header!.classList.remove("header--menu-open");
    }

    hamburger.addEventListener("click", () => {
      const expanded = hamburger.getAttribute("aria-expanded") === "true";
      hamburger.setAttribute("aria-expanded", String(!expanded));
      mobileMenu.classList.toggle("open");
      header.classList.toggle("header--menu-open");
    });

    // Close on nav link click
    mobileMenu.querySelectorAll(".mobile-menu__link").forEach((link) => {
      link.addEventListener("click", close);
    });

    // Close on resize past breakpoint
    window.addEventListener("resize", () => {
      if (window.innerWidth > 768) close();
    });
  }

  // Close the menu before the DOM is captured for the view transition
  document.addEventListener("astro:before-swap", () => {
    const hamburger = document.querySelector(".hamburger");
    const mobileMenu = document.querySelector(".mobile-menu");
    const header = document.querySelector(".header");
    hamburger?.setAttribute("aria-expanded", "false");
    mobileMenu?.classList.remove("open");
    header?.classList.remove("header--menu-open");
  });

  // Run on initial load and on Astro page transitions
  initHamburger();
  document.addEventListener("astro:after-swap", initHamburger);
</script>
